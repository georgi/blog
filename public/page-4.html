<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">

<html>
    <head>
        <title>
            Matthias Georgi
        </title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom 1.0">
        <link rel="stylesheet" media="screen" type="text/css" href="/style.css">
        <link rel="stylesheet" href="/zenburn.css">
        <script src="/highlight.pack.js">
            
        </script>
        <script>
            hljs.initHighlightingOnLoad();
        </script>
    </head>
    <body>
        <div class="container">
            <h2 id="header">
                <a href="/">
                    Matthias Georgi
                </a>
            </h2>
            <div class="content">
                <div class="article">
                    <h1>
                        <a href="/2008/9/patroon-a-javascript-template-engine.html">
                            Patroon - a Javascript Template Engine
                        </a>
                    </h1>
                    <p>Patroon is a template engine written in Javascript in about 100 lines
of code. It takes existing DOM nodes annotated with CSS classes and
expand a data object according to simple rules. Additionally you may
use traditional string interpolation inside attribute values and text
nodes.</p>

<p><strong>
Patroon has its own <a href="/patroon">project page</a> now!
Please look for current information there.
</strong></p>

<h3>Example</h3>

<p>Comments in this blog are stored as a list of JSON objects, I wrote about it <a href="http://www.matthias-georgi.de/commenting-system-with-lightweight-json-store.html">here</a>. So think about a data object like this:</p>

<pre><code>var data = { 
  comment: [{
    date: &quot;2008-09-07 12:28:33&quot;, 
    name: &quot;David Beckham&quot;,
    website: &quot;beckham.com&quot;,
    text: &quot;I watched the euro finals on tv...&quot; 
  }, { 
    date: &quot;2008-09-07 14:28:33&quot;, 
    name: &quot;Tuncay&quot;,
    website: &quot;&quot;,
    text: &quot;Me too&quot;
  }]
};
</code></pre>

<p>This data will be expanded with help of following template:</p>

<pre><code>&lt;div class=&quot;comments&quot;&gt;  
  &lt;div id=&quot;comments-template&quot;&gt;
    &lt;div class=&quot;comment&quot;&gt;
      &lt;div class=&quot;_ top&quot;&gt;
        &lt;a class=&quot;_&quot; href=&quot;{website}&quot;&gt;{name}&lt;/a&gt; said
        &lt;a class=&quot;_&quot; title=&quot;{time}&quot;&gt;&lt;/a&gt;:
      &lt;/div&gt;
      &lt;div class=&quot;text&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;   
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>

<p>The javascript to actually execute this template looks like this:</p>

<pre><code>// The comments template will be removed from the DOM!
var template = new Template(&#39;comments-template&#39;);

// template will result in a new DOM node
var result = template.expand(data);

// insert the resulting node into the comments container
var container = document.getElementsByClassName(&#39;comments&#39;)[0];
container.appendChild(result);
</code></pre>

<p>Using jQuery the code gets a bit cleaner:</p>

<pre><code>// The comments template will be removed from the DOM!
var template = new Template(&#39;comments-template&#39;);

// Expand the template into the comments section
$(&#39;.comments&#39;).expand(template, data);
</code></pre>

<h3>Basic Rules</h3>

<p>There are 5 basic rules:</p>

<ul>
<li><p>Strings and Numbers are inserted by innerHTML to the current node.</p></li>
<li><p>Arrays repeat the current node and process its elements recursively in same scope.</p></li>
<li><p>Objects trigger a class name lookup by property name. The value of each property is expanded recursively in new scope.</p></li>
<li><p>Code will be evaluated for text surounded with braces (Works also for attributes).</p></li>
<li><p>Processing child nodes will be triggered for nodes with a class attribute starting with <code>_</code>.</p></li>
</ul>

<p>I admit the last point is a bit quirky, but processing all child nodes per default is too expensive and too unpredictable. Maybe I will find a better way, but I donâ€™t mind inserting these extra <code>_</code> class names.</p>

<h3>Evaluation</h3>

<p>So speaking of the example data, this would mean following algorithm:</p>

<ul>
<li><p>Find the first node with a class name of comment.</p></li>
<li><p>Repeat this node two times and recursively process the first and second comment.</p></li>
<li><p>Descend into the node with class <code>top</code>.</p></li>
<li><p>Descend into the first link node.</p></li>
<li><p>Evaluate the code found in the <em>href</em> attribute and in the text.</p></li>
<li><p>Descend into the second link node.</p></li>
<li><p>Evaluate the code found in the <em>title</em> attribute.</p></li>
<li><p>Find the first node with the class <code>text</code>.</p></li>
<li><p>Insert the the text of the comment into the found node.</p></li>
</ul>

<p>Note that we are dealing with two scopes here: the global scope and the comment scope. The global scope just contains a name <em>comment</em> and the comment scope contains the names <code>date</code>, <code>name</code>, <code>website</code> and <code>text</code>.</p>

<h3>Download</h3>

<p>Download the script at my <a href="http://github.com/georgi/patroon/tree/master">github repository</a>.</p>

                </div>
                <div class="article">
                    <h1>
                        <a href="/2008/9/patroon-a-javascript-template-engine-part-2.html">
                            Patroon - a Javascript Template Engine (Part 2)
                        </a>
                    </h1>
                    <p>This post is an update to my <a href="http://www.matthias-georgi.de/2008/9/patroon-a-javascript-template-engine.html">initial post</a>. Patroon has been
improved and is now easier to use and uses a better algorithm
internally.</p>

<p>Patroon is a template engine written in Javascript in about 130 lines
of code. It takes existing DOM nodes annotated with class names and
expand a data object according to simple rules. Additionally you may
use traditional string interpolation inside attribute values and text
nodes.</p>

<h3>The Data</h3>

<p>Comments in this blog are stored as a list of JSON objects, I wrote
about it <a href="http://www.matthias-georgi.de/2008/9/commenting-system-with-lightweight-json-store.html">here</a>. So think about a data object like this:</p>

<pre><code>var data = { 
  comment: [{
    time: &quot;2008-09-07 12:28:33&quot;, 
    name: &quot;David Beckham&quot;,
    website: &quot;beckham.com&quot;,
    text: &quot;I watched the euro finals on tv...&quot; 
  }, { 
    time: &quot;2008-09-07 14:28:33&quot;, 
    name: &quot;Tuncay&quot;,
    website: &quot;&quot;,
    text: &quot;Me too&quot;
  }]
};
</code></pre>

<h3>The Template</h3>

<p>This data will be expanded with help of following template:</p>

<pre><code>&lt;div class=&quot;comments&quot;&gt;  
  &lt;div id=&quot;comments-template&quot;&gt;
    &lt;div class=&quot;comment&quot;&gt;
      &lt;div class=&quot;top&quot;&gt;
        {website.length &gt; 0 ? linkTo(name, website) : name} said
        &lt;a title=&quot;{time}&quot;&gt;&lt;/a&gt;:
      &lt;/div&gt;
      &lt;div class=&quot;text&quot;&gt;
        {text}
      &lt;/div&gt;
    &lt;/div&gt;   
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>

<h3>Usage</h3>

<p>The javascript to actually execute this template looks like this:</p>

<pre><code>// The comments template will be removed from the DOM!
var template = new Template(&#39;comments-template&#39;);

// Expand the template into the comments section
$(&#39;.comments&#39;).expand(template, data);
</code></pre>

<p>If you don&#39;t want to use jQuery, please look at the end of this article.</p>

<h3>Output</h3>

<p>The given example renders following output:</p>

<pre><code>&lt;div class=&quot;comments&quot;&gt;  
  &lt;div id=&quot;comments-template&quot;&gt;
    &lt;div class=&quot;comment&quot;&gt;
      &lt;div class=&quot;top&quot;&gt;
        &lt;a href=&quot;http://backham.com&quot;&gt;David Beckham&lt;/a&gt; said
        &lt;a title=&quot;2008-09-07 12:28:33&quot;&gt;2 hours ago&lt;/a&gt;
      &lt;/div&gt;
      &lt;div class=&quot;text&quot;&gt;
        I watched the euro finals on tv...
      &lt;/div&gt;
    &lt;/div&gt;   
    &lt;div class=&quot;comment&quot;&gt;
      &lt;div class=&quot;top&quot;&gt;
        Tuncay said
        &lt;a title=&quot;2008-09-07 14:28:33&quot;&gt;1 minute ago&lt;/a&gt;
      &lt;/div&gt;
      &lt;div class=&quot;text&quot;&gt;
        Me too
      &lt;/div&gt;
    &lt;/div&gt;   
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>

<h3>Basic Rules</h3>

<p>There are 3 basic rules regarding the evaluation:</p>

<ul>
<li><p>Each found class name of a node will be looked up in the current
data object. If found, the node will be processed in the new scope.
Example: the class name <code>comment</code> instructs to lookup the name
<code>comment</code> in the data object, which contains the comment array.</p></li>
<li><p>Arrays repeat the current node and process its elements recursively.</p></li>
<li><p>Code will be evaluated for text surrounded with braces (works also
for attributes). The evaluation takes place in the scope of the
current data object, which is in the example a comment object. So
the snippet <code>&lt;a title=&quot;{time}&quot;&gt;</code> will lookup the time in the comment
object and insert into the title attribute.</p></li>
</ul>

<h3>Helper</h3>

<p>Code snippets inside the template will be executed within the scope of
a Helper object. If you want to extend it, just add your functions to
<code>Template.Helper</code>. At the moment it defines only one function:</p>

<pre><code>Template.Helper = {

    linkTo: function(text, url) {
        if (url.indexOf(&#39;http://&#39;) == -1 &amp;&amp; url[0] != &#39;/&#39; &amp;&amp; url[0] != &#39;#&#39;) {
            url = &#39;http://&#39; + url;
        }
        return &#39;&lt;a href=&quot;&#39; + url +&#39;&quot;&gt;&#39; + text + &#39;&lt;/a&gt;&#39;;
    }

};
</code></pre>

<h3>Examples</h3>

<ul>
<li><a href="http://www.matthias-georgi.de/2008/9/using-javascript-templates-for-a-delicious-sidebar.html">a Delicious Sidebar</a>, which renders a <em>JSON</em> feed with the help
of Patroon.</li>
</ul>

<h3>Download</h3>

<p>Download the script at my <a href="http://github.com/georgi/patroon/tree/master">github repository</a>.</p>

<h3>Related Work</h3>

<p>There are some other libraries for javascript templating, which are
related to <strong>Patroon</strong>:</p>

<ul>
<li><a href="http://beebole.com/pure/">PURE</a></li>
<li><a href="http://jsrepeater.devprog.com/">jsRepeater</a></li>
<li><a href="http://code.google.com/p/trimpath/wiki/JavaScriptTemplates">TrimPath</a></li>
<li><a href="http://embeddedjs.com/">EmbeddedJS</a></li>
</ul>

<p>Patroon is probably the smallest templating solution around and
consists only of 130 lines of code.</p>

<h3>Appendix</h3>

<p>Without jQuery template expansion is a bit verbose:</p>

<pre><code>@@javascript

// The comments template will be removed from the DOM!
var template = new Template(&#39;comments-template&#39;);

// template will result in a new DOM node
var result = template.expand(data);

// insert the resulting node into the comments container
var container = document.getElementsByClassName(&#39;comments&#39;)[0];
container.appendChild(result);
</code></pre>

                </div>
                <div class="article">
                    <h1>
                        <a href="/2008/9/emacs-completions.html">
                            Emacs Completions with Hippie-Expand and Snippets
                        </a>
                    </h1>
                    <p>One of the most important features of a text editor is the completing
of text inside a buffer. There a lots of packages for Emacs, which
provide this feature in many different ways. I will show you, what I
use to improve my life as coder.</p>

<p><EMBED SRC="/shockwaves/emacs-completion.swf" WIDTH=400 HEIGHT=320 quality=low loop=false TYPE="application/x-shockwave-flash" PLUGINSPAGE="http://www.macromedia.com/shockwave/download/index.cgi?P1_Prod_Version=ShockwaveFlash"></p>

<h3>Multifunctional tab key</h3>

<p>Most of the time the tab key in Emacs is bound to the indentation
command, which will indent the current line. So if you want to use the
tab key for other things, you need some kind of multiplexer, which
tries to figure out, what is the right thing to do in each situation.</p>

<p>So I copied the indent-and-complete from the <a href="http://dima-exe.ru/rails-on-emacs" title="Emacs Rails package">emacs-rails package</a>:</p>

<pre><code>(require &#39;hippie-exp)
(require &#39;snippet)

(defun indent-and-complete ()
  &quot;Indent line and complete&quot;
  (interactive)

  (cond
   ((and (boundp &#39;snippet) snippet)
    (snippet-next-field))

   ((looking-at &quot;\\\\_&gt;&quot;)
    (hippie-expand nil))

   ((indent-for-tab-command))))
</code></pre>

<p>The function <code>indent-and-complete</code> does one of the following actions:</p>

<ul>
<li>if a snippet is active, it jumps to the next field</li>
<li>if we are at a word boundary, it tries to complete with <code>hippie-expand</code></li>
<li>otherwise it indents the current line</li>
</ul>

<h3>HTML mode initialization</h3>

<p>Well, this function alone will not change your editor behaviour. For
activating our tab function, we need to bind the tab key.</p>

<p>Additionally we want to setup <code>hippie-expand</code>, an expansion package,
which will try to expand the word before the cursor in a configurable
way. <code>hippie-expand-try-functions-list</code> is a variable, which defines a
list of functions, which should be called for completion.</p>

<p>Let&#39;s have a look at my <code>html-mode</code> initialization function. It will configure
the completion behaviour of hippie-expand an bind the tab key to <code>indent-and-complete</code>.</p>

<pre><code>;; We need a simple wrapper for expand-abbrev
(defun try-expand-abbrev (old)
  (expand-abbrev))

;; ********************************************************************************
;; HTML Mode
;;
(add-to-list &#39;auto-mode-alist &#39;(&quot;\\\\.html\\\\&#39;&quot; . html-mode))

(defun html-mode-on-init ()
  (set (make-local-variable &#39;hippie-expand-try-functions-list)
       &#39;(try-expand-abbrev
         try-expand-dabbrev))
  (define-key html-mode-map (kbd &quot;&lt;tab&gt;&quot;) &#39;indent-and-complete))

(add-hook &#39;html-mode-hook &#39;html-mode-on-init)    
</code></pre>

<p>There a two functions, which will be asked to complete the current word:</p>

<ul>
<li><p><code>try-expand-abbrev</code>: Expands the current word by looking into the
list of defined abbreviations. So called abbrevs are just shortcuts
in Emacs. So if you type <code>li</code> and hit the tab key it will be
expanded to <code>&lt;li&gt;&lt;/li&gt;</code>.</p></li>
<li><p><code>try-expand-dabbrev</code>: Dynamic abbreviation is a pragmatic method for
completing words. Emacs will look for words with the same beginning
and use them for completion. Hitting multiple times the tab key will
give you different completions, as you may know from the unix shell.</p></li>
</ul>

<h3>Defining your snippets</h3>

<p>Now if you want to use snippets for your <code>html-mode</code>, you have to
define a abbrev-table with your desired snippets. </p>

<pre><code>(define-abbrev-table &#39;html-mode-abbrev-table ())

(snippet-with-abbrev-table &#39;html-mode-abbrev-table 
 (&quot;h1&quot;      . &quot;&lt;h1&gt;$.&lt;/h1&gt;&quot;)
 (&quot;h2&quot;      . &quot;&lt;h2&gt;$.&lt;/h2&gt;&quot;)
 (&quot;h3&quot;      . &quot;&lt;h3&gt;$.&lt;/h3&gt;&quot;)
 (&quot;h4&quot;      . &quot;&lt;h3&gt;$.&lt;/h4&gt;&quot;)
 (&quot;h5&quot;      . &quot;&lt;h3&gt;$.&lt;/h5&gt;&quot;)
 (&quot;h6&quot;      . &quot;&lt;h6&gt;$.&lt;/h6&gt;&quot;)
 (&quot;div&quot;     . &quot;&lt;div&gt;$.&lt;/div&gt;&quot;)
 (&quot;divc&quot;    . &quot;&lt;div class=\&quot;$${class}\&quot;&gt;$.&lt;/div&gt;&quot;)
 (&quot;span&quot;    . &quot;&lt;span&gt;$.&lt;/span&gt;&quot;)
 (&quot;spans&quot;   . &quot;&lt;span style=\&quot;$${style}\&quot;&gt;$.&lt;/span&gt;&quot;)
 (&quot;form&quot;    . &quot;&lt;form action=\&quot;$${action}\&quot; method=\&quot;$${post}\&quot;&gt;$.&lt;/form&gt;&quot;)
 (&quot;input&quot;   . &quot;&lt;input type=\&quot;$${text}\&quot; name=\&quot;$${name}\&quot; value=\&quot;$${value}\&quot;/&gt;&quot;)
 (&quot;a&quot;       . &quot;&lt;a href=\&quot;$${href}\&quot;&gt;$.&lt;/a&gt;&quot;)
 (&quot;br&quot;      . &quot;&lt;br/&gt;$.&quot;)
 (&quot;ul&quot;      . &quot;&lt;ul&gt;$.&lt;/ul&gt;&quot;)
 (&quot;ol&quot;      . &quot;&lt;ul&gt;$.&lt;/ul&gt;&quot;)
 (&quot;li&quot;      . &quot;&lt;li&gt;$.&lt;/li&gt;&quot;)
 (&quot;tab&quot;     . &quot;&lt;table&gt;$.&lt;/table&gt;&quot;)
 (&quot;tr&quot;      . &quot;&lt;tr&gt;$.&lt;/tr&gt;&quot;)
 (&quot;td&quot;      . &quot;&lt;td&gt;$.&lt;/td&gt;&quot;)
 (&quot;th&quot;      . &quot;&lt;th&gt;$.&lt;/th&gt;&quot;)
 (&quot;str&quot;     . &quot;&lt;strong&gt;$.&lt;/strong&gt;&quot;)
 (&quot;em&quot;      . &quot;&lt;em&gt;$.&lt;/em&gt;&quot;)
 (&quot;meta&quot;    . &quot;&lt;meta name=\&quot;$${name}\&quot; content=\&quot;$${content}\&quot;/&gt;&quot;)
 (&quot;style&quot;   . &quot;&lt;style type=\&quot;text/css\&quot;&gt;$.&lt;/style&gt;&quot;)
 (&quot;script&quot;  . &quot;&lt;script type=\&quot;text/javascript\&quot;&gt;$.&lt;/script&gt;&quot;)
 (&quot;scripts&quot; . &quot;&lt;script src=\&quot;$${src}\&quot; type=\&quot;text/javascript\&quot;&gt;$.&lt;/script&gt;&quot;)
 (&quot;img&quot;     . &quot;&lt;img src=\&quot;$.\&quot;/&gt;&quot;)
 (&quot;link&quot;    . &quot;&lt;link href=\&quot;$${href}\&quot; media=\&quot;screen\&quot; rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot;/&gt;&quot;))
</code></pre>

<p>Great. If you put all the code in your .emacs file, you should be able
to use your tab key for completions. In our case we defined snippets
for the <code>html-mode</code> and activated <code>hippie-expand</code> to use abbrevs and
dynamic abbreviation. There is much more stuff I will show you next
time, like customizations for other language modes like <em>Ruby</em> and
<em>Javascript</em>.</p>

                </div>
                <a rel="next" href="page-5.html">
                    Next entries
                </a>
            </div>
        </div>
    </body>
</html>
