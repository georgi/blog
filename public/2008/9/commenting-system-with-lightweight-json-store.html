<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Matthias Georgi - Commenting system with lightweight JSON store</title>
    <meta http-equiv="Content-Language" content="English" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/matthias-georgi" />
    <link rel="stylesheet" href="../../stylesheets/all.css?1220922874" media="screen"></link>
<link rel="stylesheet" href="../../stylesheets/style.css?1220869897" media="screen"></link>
    <script>var Blog = { root: '../../', guid: '4ed200b0-5efa-012b-f5dc-001a92975b89' };</script>
  </head>
  <body>
    <div class="container">

      <div id="header" class="column span-20 last">
	<h1><a href="../../index.html">Matthias Georgi</a></h1>
	<h2>Webdev, Gamedev, Interaction Design</h2>
      </div>

      <div id="navi"  class="column span-20 last">
	<ul>
	  <li><a class="" href="../../index.html">Home</a></li>
	  
	    <li><a class="" href="../../categories/ruby.html">Ruby</a></li>
	  
	    <li><a class="active" href="../../categories/javascript.html">Javascript</a></li>
	  
	    <li><a class="" href="../../categories/emacs.html">Emacs</a></li>
	  
	  <li><a class="" href="../../about.html">About</a></li>
	</ul>
      </div>

      
	<div id="header-text" class="column span-20 last">
	  <h1>Javascript</h1>
	</div>
      

      <div class="content column span-15"> 
	<div class="article">

  <div class="date">
    September 7, 2008
  </div>

  <h2>Commenting system with lightweight JSON store</h2>  

  <p>As I wrote this <a href="shinmun-a-small-and-beautiful-blog-engine.html">blog engine</a>, the need for a commenting system
arose and I reflected about a small and simple commenting system with
just a flat file JSON store. This is my solution, which can be used on
any static page on a server with PHP support.</p>

<h3>JQuery Frontend</h3>

<p>First of all we need a form, which will post the data to the <em>PHP</em>
script. The comment rendering is done by my own <em>Javascript</em>
templating system, which I will explain in a seperate post. For now we
focus on the task of posting a form and saving it to our <em>JSON</em> store.</p>

<pre><code>&lt;div class="comment-form"&gt;
    &lt;form&gt;
      &lt;input type="hidden" name="guid" value="7ad04f10-5dd6-012b-b53c-001a92975b89"/&gt;
      &lt;p&gt;
        &lt;label&gt;Name&lt;/label&gt;&lt;br/&gt;
        &lt;input type="text" name="name" size="40"/&gt;
      &lt;/p&gt;
      &lt;p&gt;
        &lt;label&gt;Website&lt;/label&gt;&lt;br/&gt;
        &lt;input type="text" name="website"  size="40"/&gt;
      &lt;/p&gt;
      &lt;p&gt;
        &lt;label&gt;Comment&lt;/label&gt;&lt;br/&gt;
        &lt;textarea name="text" cols="60" rows="10"&gt;&lt;/textarea&gt;
      &lt;/p&gt;
      &lt;p&gt;
        &lt;input type="submit" value="Post comment"/&gt;
      &lt;/p&gt;
    &lt;/form&gt;
&lt;/div&gt;
</code></pre>

<p>My blog engine generates a guid for each post, so this will be posted
by the form as well. Ok, let&#8217;s have a look at the Javascript code:</p>

<pre><code>$('.comment-form form').ajaxForm({
    url: Blog.root + 'controllers/comments.php',
    type: 'POST',
    resetForm: true,
    beforeSubmit: function(values) {
        if (values[1].value &amp;&amp; values[3].value) {
            return true;
        }
        else {
            alert('Please enter name and text!');
            return false;
        }
    },
    success: function(data) {
        renderComments(data);
    }
});
</code></pre>

<p>This uses the <a href="http://malsup.com/jquery/form/">jquery-form plugin</a> to submit the form via <em>AJAX</em>,
nothing special here, the input will be validated to have at least a
name and comment text. After a successful comment post, the comments
should be rendered, but this is another story.</p>

<h3>PHP Backend</h3>

<p>The backend is extremely <a href="http://en.wikipedia.org/wiki/You_Ain%27t_Gonna_Need_It">YAGNI</a>. Comments for one post, will be
saved in one JSON file like <code>comments/guid-of-the-post</code>. The 4 fields
will be encoded as json array and appended to the file. This happens
only, if the request was a <em>POST</em>. Finally we read the whole file and
send it back as response.</p>

<pre><code>&lt;?php

$guid_pattern = "/^(\{{0,1}([0-9a-fA-F]){8}-([0-9a-fA-F]){4}-([0-9a-fA-F]){4}-([0-9a-fA-F]){4}-([0-9a-fA-F]){12}\}{0,1})$/";
$req = $_REQUEST;
$guid = $req['guid'];

preg_match($guid_pattern, $guid) or die("invalid guid");

$file = 'comments/' . $guid;

if ($_SERVER['REQUEST_METHOD'] == 'POST') {   
  // create a comment record
  $record = array(date('Y-m-d H:i:s'), 
                  strip_tags(stripslashes($req['name'])),
                  strip_tags(stripslashes($req['website'])),
                  strip_tags(stripslashes($req['text'])));

  // encode as json string
  $json = json_encode($record) . "\n";

  // open the comment file for appending
  $fp = fopen($file, "a");

  // acquire a write lock
  flock($fp, LOCK_EX);

  // append the json line
  fwrite($fp, $json);

  // release lock
  flock($fp, LOCK_UN);

  // close file
  fclose($fp);
}

if (file_exists($file)) {    
  // open the comment file for reading
  $fp = fopen($file, "r");

  // acquire a read lock
  flock($fp, LOCK_SH);

  // read whole file and print it out
  echo fread($fp, filesize($file));

  // release lock
  flock($fp, LOCK_UN);

  // close file
  fclose($fp);
}

?&gt;
</code></pre>

<p>One important thing to note is, that the comment file is not one big
JSON array. It looks like this:</p>

<pre><code>["2008-09-07 12:28:33","Hans","","**strong text**\n*emphasized text*"]
["2008-09-07 12:29:33","Hans","","**strong text**\n\n\n*emphasized text*"]
["2008-09-07 12:29:56","Hans","","**strong text**\n\n\n*emphasized text*"]
</code></pre>

<p>For each line, we have one JSON array. This way, the <em>PHP</em> script
doesn&#8217;t need to read the whole JSON thing into memory. It just appends
on every <em>POST</em> one line.</p>

<h3>Escaping</h3>

<p>Some blog comments showed strange escaping behviour, so I investigated
further. PHP has a foolproof feature called <a href="http://de.php.net/manual/en/security.magicquotes.php">Magic Quotes</a>. It
automatically escapes all dangerous characters from request parameters
to protect dumb users from <a href="http://en.wikipedia.org/wiki/SQL_injection">SQL Injection</a>. This feature is
deprecated and in version 6.0.0 it will be removed. Nevertheless it is 
activated in a default PHP installation.</p>

<p>To revert the escaping behaviour I have to call <code>stripslashes</code>. Also I
have to care about stripping HTML tags from input. So to protect from
malicious HTML, I filter all input through <code>strip_tags</code>.</p>

<h3>Concurrency</h3>

<p>As a commenter pointed out, concurrent access can be a headache. I
hoped, that <code>file_put_contents</code> is an atomic function, but it is
not. However, I use a simple file locking scheme, which is good
enough. One caveat remains: in a multithreading environment this will
not work reliably. But I think, most PHP installations run as CGI, so
this will be ok.</p>

<h3>Security</h3>

<p>Seems that I had a serious security flaw in my first version. I didn&#8217;t
check the guid parameter, so that you could pass a path like 
<code>../../../../../../etc/group</code>. Now the guid is matched against a regular
expression, so the script is now safe.</p>

<h3>Conclusion</h3>

<p>With a few lines you can hook up a simple commenting system for static
pages powered by <em>AJAX</em> and <em>PHP</em>. Note, that rendering of comments is
not discussed here and happens on <em>Javascript</em> side. I will write
about my <em>Javascript template engine</em> later in a seperate post.</p>

  <h3>Comments</h3>

  <div class="comments-loading" style="display:none">
    <img src="../../images/loading.gif"></img>
    Loading Comments...
  </div>

  <div class="comments">  
    <div id="comments-template">
      <div class="comment">
	<div class="_ top">
	  <a class="_" href="{website}">{name}</a> said
	  <a class="_" title="{time}"></a>:
	</div>
	<div class="text"></div>
      </div>
    </div>
  </div>

  <hr/>  

  <div class="comment-form-loading" style="display:none">
    <img src="../../images/loading.gif"></img>
    Posting Comment...
  </div>

  <div class="comment-form">
    <h4>Leave a comment</h4>
    <form>
      <input type="hidden" name="guid" value="4ed200b0-5efa-012b-f5dc-001a92975b89"/>
      <p>
	<label>Name</label><br/>
	<input type="text" name="name" size="40"/>
      </p>
      <p>
	<label>Website</label><br/>
	<input type="text" name="website"  size="40"/>
      </p>
      <p>
	<label>Comment (Use markdown for formatting)</label><br/>
	<textarea name="text" cols="60" rows="10"></textarea>
      </p>
      <p>
	<input type="submit" value="Post comment"/>
      </p>
    </form>
  </div>
</div>



      </div>

      <div class="right column span-5 last"> 

	<h4>Subscribe</h4>

	<p>
	  <a href="http://feeds.feedburner.com/matthias-georgi" rel="alternate" type="application/rss+xml">
	    <img src="../../images/rss.png"></img>
	    <img src="http://feeds.feedburner.com/~fc/matthias-georgi?bg=99CCFF&amp;fg=444444&amp;anim=0" height="26" width="88"/>
	  </a>
	  <br/>
	  <a href="http://www.feedburner.com/fb/a/emailverifySubmit?feedId=2408112&amp;loc=en_US">
	    Subscribe by Email
	  </a>
	</p>
	  
	<h4>About</h4>

	<div class="about">
	  Matthias Georgi lives in
	  <em>Darmstadt, Germany</em> and works as a freelance
	  software developer.
	  <a href="../../about.html">read more</a>
	</div>

	<h4>Archives</h4>

	<ul>
	  
	    <li><a href="../../2007/4/index.html">April 2007</a></li> 
	  
	    <li><a href="../../2007/5/index.html">May 2007</a></li> 
	  
	    <li><a href="../../2008/9/index.html">September 2008</a></li> 
	  
	</ul>

	<h4>Recent posts</h4>

	<ul>
	  
	    <li><a href="../../2008/9/commenting-system-with-lightweight-json-store.html">Commenting system with lightweight JSON store</a></li> 
	  
	    <li><a href="../../2008/9/shinmun-a-small-and-beautiful-blog-engine.html">Shinmun, a small and beautiful blog engine</a></li> 
	  
	    <li><a href="../../2008/9/emacs-completions.html">Emacs Completions with Hippie-Expand and Snippets</a></li> 
	  
	    <li><a href="../../2007/5/google-like-search-results-helper.html">Google-like Search Results Helper</a></li> 
	  
	    <li><a href="../../2007/4/dry-up-your-url-helpers.html">DRY Up Your Url Helpers</a></li> 
	  
	</ul>

	<h4>My Projects</h4>

	<ul>
	  <li>
	    <a href="http://github.com/georgi/shinmun/tree/master">
	      Shinmun, a small blog engine
	    </a>
	  </li>
	</ul>

	<h4>My Music</h4>

	<ul>
	  <li>
	    <a href="http://www.p-ersag.com">
	      Planet Ersag
	    </a>
	  </li>
	</ul>

      </div>
    </div>

    <script type="text/javascript" src="../../javascripts/all.js?1220922874"></script>
<script type="text/javascript" src="../../javascripts/highlight.js?1216329729"></script>
<script type="text/javascript" src="../../javascripts/showdown.js?1205881696"></script>
<script type="text/javascript" src="../../javascripts/template.js?1220744554"></script>
<script type="text/javascript" src="../../javascripts/default.js?1220656864"></script>
<script type="text/javascript" src="../../javascripts/comments.js?1220887453"></script>
<script type="text/javascript" src="../../javascripts/wmd.js?1205881696"></script>

    <script type="text/javascript">
      hljs.initHighlightingOnLoad('ruby', 'html', 'css', 'php', 'javascript', 'sql', 'lisp', 'xml', 'java');
    </script>

    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>

    <script type="text/javascript">
      var pageTracker = _gat._getTracker("UA-927203-10");
      pageTracker._trackPageview();
    </script>

  </body>
</html>
