<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Matthias Georgi - Fast Auto-completion with Rails, Scriptaculous and JSON</title>
    <meta http-equiv="Content-Language" content="English" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/matthias-georgi" />
    <link rel="stylesheet" href="../../stylesheets/all.css?1220966387" media="screen"></link>
<link rel="stylesheet" href="../../stylesheets/style.css?1220965122" media="screen"></link>
    <script>var Blog = { root: '../../', guid: '9dba67e0-5d6c-012b-b53a-001a92975b89' };</script>
  </head>
  <body>
    <div class="container">

      <div id="header" class="column span-20 last">
	<h1><a href="../../index.html">Matthias Georgi</a></h1>
	<h2>Webdev, Gamedev, Interaction Design</h2>
      </div>

      <div id="navi"  class="column span-20 last">
	<ul>
	  <li><a class="" href="../../index.html">Home</a></li>
	  
	    <li><a class="active" href="../../categories/ruby.html">Ruby</a></li>
	  
	    <li><a class="" href="../../categories/javascript.html">Javascript</a></li>
	  
	    <li><a class="" href="../../categories/emacs.html">Emacs</a></li>
	  
	  <li><a class="" href="../../about.html">About</a></li>
	</ul>
      </div>

      
	<div id="header-text" class="column span-20 last">
	  <h1>Ruby</h1>
	</div>
      

      <div class="content column span-15"> 
	<div class="article">

  <div class="date">
    April 4, 2007
  </div>

  <h2>Fast Auto-completion with Rails, Scriptaculous and JSON</h2>  

  <p>Inspired by the excellent <a href="http://www.pragmaticprogrammer.com/titles/fr_rr/">Rails Recipes</a> book , I created an
improved Auto-completion helper, which uses <em>JSON</em> and <em>AJAX</em> instead
of a script tag for loading the completions. What we want to achieve
is a search field, which pops up immediately, showing us a list of
possible completions for our search word. Look at <a href="http://labs.google.com/suggest/">Google Suggest</a>
to get an idea.</p>

<h3>Rails Autocomplete</h3>

<p>Rails already has an <code>auto_complete_field</code>, which sends an AJAX
request for each keystroke. This approach is quite slow, but works in
most cases, especially for large datasets <code>auto_complete_field</code> is the
better choice. Our idea, stolen from the Rails Recipes book is to
fetch the array of possible completions only once. Each keystroke will
trigger only a local lookup and need no further server interaction.</p>

<p>Scriptaculous already has the right tool for this job:
<a href="http://wiki.script.aculo.us/scriptaculous/show/Autocompleter.Local">Autocompleter.Local</a>.  We will just pass a javascript array of
possible completions to the constructor and we&#8217;re done.</p>

<h3>CSS</h3>

<p>OK, let&#8217;s start. First we need the CSS used by <code>Autocompleter.Local</code>,
which styles the choices box:</p>

<pre><code>div.auto_complete {
  width: 350px;
  background: #fff;
}

div.auto_complete ul {
  border:1px solid #888;
  margin:0;
  padding:0;
  width:100%;
  list-style-type:none;
}

div.auto_complete ul li {
  margin:0;
  padding:3px;
}

div.auto_complete ul li.selected {
  background-color: #ffb;
}

div.auto_complete ul strong.highlight {
  color: #800;
  margin:0;
  padding:0;
}
</code></pre>

<h3>Controller</h3>

<p>Rails already has an controller macro for generating a auto completion
action. We will create a similar macro, which will generate an action,
which in turn generates the <em>JSON</em> response. Sounds complex, but the
implementation is quite easy. Just add to your ApplicationController:</p>

<pre><code>def self.fast_auto_complete_for(object, method, options = {})
 define_method("auto_complete_for_#{object}_#{method}") do
   render :json =&gt; object.to_s.camelize.constantize.find(:all).map(&amp;method).to_json
  end
end
</code></pre>

<p>The response of the generated action will now contain a list of all
values for the desired attribute. You can use it like in your
controllers: <code>fast_auto_complete_for :sport, :name</code></p>

<h3>Javascript Helper</h3>

<p>Now let us get into the tricky part: the javascript macro helper. How
will we get the completion list? <em>Prototype</em> includes the <code>Ajax.Request</code>
class, which sends an Ajax Request to our generated action and fetches
the array encoded as <em>JSON</em>. Furthermore we have to generate a div which
will hold the popup list for our completion entries. Without going
into detail, I&#8217;ll just show you the code, which you add to your
<code>ApplicationHelper</code>:</p>

<pre><code>def fast_auto_complete_field(field_id, options={})
  div_id = "#{field_id}_auto_complete"
  url = options.delete(:url) or raise "url required"
  options = options.merge(:tokens =&gt; ',', :frequency =&gt; 0 )
  script = javascript_tag &lt;&lt;-end
    new Ajax.Request('#{url}', {
      method: 'get',
      onSuccess: function(transport) {
        new Autocompleter.Local('#{field_id}', '#{div_id}', eval(transport.responseText), #{options.to_json});
      }
    });
  end
  content_tag 'div', script, :class =&gt; 'auto_complete', :id =&gt; div_id
end
</code></pre>

<p>Our helper needs the id for the text field we want to enhance. Based
on this id the helper generates the div for presenting the completion
entries. It is also required to pass the url of the json action, which
is in our case <code>/sports/auto_complete_for_sport_name</code>. </p>

<h3>Usage example</h3>

<pre><code>&lt;form&gt;
  &lt;input type="text" name="name" id="sport_name"/&gt;
  &lt;input type="submit" value="Search"/&gt;
&lt;/form&gt;

&lt;%= fast_auto_complete_field :sport_name, :url =&gt; '/sports/auto_complete_for_sport_name' %&gt;
</code></pre>

<p>Well, that&#8217;s it. Now you may enjoy snappy auto-completion and feel
good about using bleeding edge technology like <code>AJAX</code> and <code>JSON</code>.</p>

  <hr/>

  <div style="padding-bottom:40px">
    <script type="text/javascript">
      if (typeof window.Delicious == "undefined") window.Delicious = {};
      Delicious.BLOGBADGE_DEFAULT_CLASS = 'delicious-blogbadge-line';
    </script>
    <script src="http://static.delicious.com/js/blogbadge.js"></script>
  </div>

  <h2>Comments</h2>

  <div class="comments-loading" style="display:none">
    <img src="../../images/loading.gif"></img>
    Loading Comments...
  </div>

  <div class="comments">  
    <div id="comments-template">
      <div class="comment">
	<div class="_ top">
	  <a class="_" href="{website}">{name}</a> said
	  <a class="_" title="{time}"></a>:
	</div>
	<div class="text"></div>
      </div>
    </div>
  </div>

  <hr/>  

  <div class="comment-form-loading" style="display:none">
    <img src="../../images/loading.gif"></img>
    Posting Comment...
  </div>

  <div class="comment-form">
    <h4>Leave a comment</h4>
    <form>
      <input type="hidden" name="guid" value="9dba67e0-5d6c-012b-b53a-001a92975b89"/>
      <p>
	<label>Name</label><br/>
	<input type="text" name="name" size="40"/>
      </p>
      <p>
	<label>Website</label><br/>
	<input type="text" name="website"  size="40"/>
      </p>
      <p>
	<label>Comment (Use markdown for formatting)</label><br/>
	<textarea name="text" cols="60" rows="10"></textarea>
      </p>
      <p>
	<input type="submit" value="Post comment"/>
      </p>
    </form>
  </div>
</div>



      </div>

      <div class="right column span-5 last"> 

	<h4>Subscribe</h4>

	<p>
	  <a href="http://feeds.feedburner.com/matthias-georgi" rel="alternate" type="application/rss+xml">
	    <img src="../../images/rss.png"></img>
	    <img src="http://feeds.feedburner.com/~fc/matthias-georgi?bg=99CCFF&amp;fg=444444&amp;anim=0" height="26" width="88"/>
	  </a>
	  <br/>
	  <a href="http://www.feedburner.com/fb/a/emailverifySubmit?feedId=2408112&amp;loc=en_US">
	    or subscribe by email
	  </a>
	</p>
	  
	<h4>About</h4>

	<div class="about">
	  Matthias Georgi lives in
	  <em>Darmstadt, Germany</em> and works as a freelance
	  software developer.
	  <a href="../../about.html">read more</a>
	</div>

	<h4>Archives</h4>

	<ul>
	  
	    <li><a href="../../2007/4/index.html">April 2007</a></li> 
	  
	    <li><a href="../../2007/5/index.html">May 2007</a></li> 
	  
	    <li><a href="../../2008/9/index.html">September 2008</a></li> 
	  
	</ul>

	<h4>Recent posts</h4>

	<ul>
	  
	    <li><a href="../../2008/9/patroon-a-javascript-template-engine.html">Patroon - a Javascript Template Engine</a></li> 
	  
	    <li><a href="../../2008/9/commenting-system-with-lightweight-json-store.html">Commenting system with lightweight JSON store</a></li> 
	  
	    <li><a href="../../2008/9/shinmun-a-small-and-beautiful-blog-engine.html">Shinmun, a small and beautiful blog engine</a></li> 
	  
	    <li><a href="../../2008/9/emacs-completions.html">Emacs Completions with Hippie-Expand and Snippets</a></li> 
	  
	    <li><a href="../../2007/5/google-like-search-results-helper.html">Google-like Search Results Helper</a></li> 
	  
	</ul>

	<h4>My Projects</h4>

	<ul>
	  <li>
	    <a href="http://github.com/georgi/shinmun/tree/master">
	      Shinmun at github
	    </a>
	  </li>
	  <li>
	    <a href="http://www.matthias-georgi.de/2008/9/shinmun-a-small-and-beautiful-blog-engine.html">
	      Shinmun description
	    </a>
	  </li>
	</ul>

	<h4>My Music</h4>

	<ul>
	  <li>
	    <a href="http://www.p-ersag.com">
	      Planet Ersag
	    </a>
	  </li>
	</ul>

      </div>
    </div>

    <script type="text/javascript" src="../../javascripts/all.js?1220966387"></script>
<script type="text/javascript" src="../../javascripts/showdown.js?1205881696"></script>
<script type="text/javascript" src="../../javascripts/template.js?1220960964"></script>
<script type="text/javascript" src="../../javascripts/default.js?1220656864"></script>
<script type="text/javascript" src="../../javascripts/comments.js?1220887453"></script>
<script type="text/javascript" src="../../javascripts/wmd.js?1205881696"></script>

    
      <script type="text/javascript" src="../../javascripts/highlight.js?1220965535"></script>
      <script type="text/javascript">
	hljs.initHighlightingOnLoad('ruby','html','css');
      </script>
    

    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>

    <script type="text/javascript">
      var pageTracker = _gat._getTracker("UA-927203-10");
      pageTracker._trackPageview();
    </script> 

  </body>
</html>
