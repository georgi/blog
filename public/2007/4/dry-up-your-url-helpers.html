<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Matthias Georgi - DRY Up Your Url Helpers</title>
    <meta http-equiv="Content-Language" content="English" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/matthias-georgi" />
    <link href="../../stylesheets/all.css?1220823609" media="screen" rel="stylesheet"></link>
<link href="../../stylesheets/style.css?1220823092" media="screen" rel="stylesheet"></link>
    <script>var Blog = { root: '../../', guid: '9dba2130-5d6c-012b-b53a-001a92975b89' };</script>
  </head>
  <body>
    <div class="container">

      <div id="header" class="column span-20 last">
	<h1><a href="../../index.html">Matthias Georgi</a></h1>
	<h2>Webdev, Gamedev, Interaction Design</h2>
      </div>

      <div id="navi"  class="column span-20 last">
	<ul>
	  <li><a class="" href="../../index.html">Home</a></li>
	  
	    <li><a class="active" href="../../categories/ruby.html">Ruby</a></li>
	  
	    <li><a class="" href="../../categories/javascript.html">Javascript</a></li>
	  
	    <li><a class="" href="../../categories/emacs.html">Emacs</a></li>
	  
	  <li><a class="" href="../../about.html">About</a></li>
	</ul>
      </div>

      
	<div id="header-text" class="column span-20 last">
	  <h1>Ruby</h1>
	</div>
      

      <div class="content column span-15"> 
	<div class="article">

  <div class="date">
    April 18, 2007
  </div>

  <h2>DRY Up Your Url Helpers</h2>  

  <p>This tutorial shows you how to simplify url generation in combination
with <em>RESTful</em> resources by extending the <code>url_for</code> helper. This approach
will also work with nested routes and other helpers like <code>form_tag</code> and
<code>link_to</code>.</p>

<p>One of the concepts of <em>REST</em> is: each resource has its own unique
<em>URI</em>. We will enhance the <code>url_for</code> helper to generate this unique URI
for an arbitrary record.</p>

<p>First we need a simple example. We have 2 models: <code>User</code> and
<code>Article</code>. For our url generation to work we have to add following code
to our models:</p>

<pre><code>class User
  has_many :articles

  def to_params
    {:id =&gt; permalink}
  end
end

class Article
  belongs_to :user

  def to_params
    {:user_id =&gt; user.permalink, :id =&gt; permalink}
  end
end
</code></pre>

<p>This is necessary for nested routes to play nicely with our url
generation code. We are now able to find the parameters for each
record to generate an unique URL.</p>

<p>In a previous post I demonstrated the use of meaningful urls. We are
going now the same way.</p>

<p>Users are identified by an URL like:</p>

<pre><code>/users/matthias-georgi
</code></pre>

<p>Each user may write articles, which are located at:</p>

<pre><code>/users/matthias-georgi/articles
</code></pre>

<p>If I want to write a new article, I will use this URL:</p>

<pre><code>/users/matthias-georgi/articles/new
</code></pre>

<p>Editing an existing article would end up on this URL:</p>

<pre><code>/users/matthias-georgi/articles/my-first-post;edit
</code></pre>

<p>For nested resources to get working you define in config/routes.rb:</p>

<pre><code>map.resources :users do |user|
  user.resources :articles
end
</code></pre>

<p>The traditional way to generate urls is to call the resource helpers:</p>

<pre><code>article_url(article.user, article)
</code></pre>

<p>This is redundant, as the article already knows its user.</p>

<p>Add following module into your lib folder and include the module in
both your application controller and application helper. The most
important bit is the url_for method. It will automatically generate
the right url for your resource.</p>

<pre><code>module ResourceHelper

  def plural_class_name(record)
    singular_class_name(record).pluralize
  end

  def singular_class_name(record)
    record.class.name.underscore.tr('/', '_')
  end

  def params_for(record)
    if record.respond_to?(:to_params)
      record.to_params
    else
      {:id =&gt; record.to_param}
    end
  end

  def collection_url(collection, record, options)
    if record
      params = params_for(record)
      params["#{singular_class_name(record)}_id".to_sym] = params.delete(:id)
      url_for options.merge(params).merge(:controller =&gt; collection)
    else
      url_for options.merge(:controller =&gt; collection)
    end
  end

  def member_url(record, options)
    url_for options.merge(params_for(record)).merge(:controller =&gt; plural_class_name(record))
  end

  def url_for(*args)
    if [String, Hash].any? {|type| args.first.is_a? type }
      super(*args)
    else
      if args[0].is_a?(Symbol)
        collection_url(args[0], args[1], :action =&gt; 'index')
      else
        member_url(args.first, :action =&gt; 'show')
      end
    end
  end

  def new_url_for(collection, record=nil)
    collection_url(collection, record, :action =&gt; 'new')
  end

  def edit_url_for(record)
    member_url(record, :action =&gt; 'edit')
  end

  def path_for(*args)
    if args[0].is_a?(Symbol)
      collection_url(args[0], args[1], :action =&gt; 'index', :only_path =&gt; true)
    else
      member_url(args.first, :action =&gt; 'show', :only_path =&gt; true)
    end
  end

  def new_path_for(collection, record=nil)
    collection_url(collection, record, :action =&gt; 'new', :only_path =&gt; true)
  end

  def edit_path_for(record)
    member_url(record, :action =&gt; 'edit', :only_path =&gt; true)
  end

end
</code></pre>

<p>So how can you use this stuff actually?</p>

<p>It is pretty easy: just pass the record instead of the url hash and
the unique url will be generated automatically.</p>

<p>The url of a collection is treated differently. You have to pass the
name of the collection, which is the controller name. For nested
resources you have to pass additionally the record, the collection is
belonging to.</p>

<p>Some examples:</p>

<pre><code>new_path_for(:users)          # =&gt; '/users/new'
path_for(user)                # =&gt; '/users/harald'
edit_path_for(user)           # =&gt; '/users/harald;edit'
path_for(:articles, user)     # =&gt; '/users/harald/articles'
new_path_for(:articles, user) # =&gt; '/users/harald/articles/new'
path_for(article)             # =&gt; '/users/harald/articles/article-1'
edit_path_for(article)        # =&gt; '/users/harald/articles/article-1;edit'

# This works for helpers like url_for, form_tag or link_to. 

link_to article.title, article
form_tag :articles
form_tag article, :method =&gt; 'put'
</code></pre>

<p>If anybody is interested I will release this stuff as plugin. I think
other helpers could benefit as well as you can pass your records
around and each helper may generate the appropriate url.</p>

  <h3>Comments</h3>

  <div class="comments-loading" style="display:none">
    <img src="../../images/loading.gif"></img>
    Loading Comments...
  </div>

  <div class="comments">  
    <div id="comments-template">
      <div class="comment">
	<div class="_ top">
	  <a class="_" href="{website}">{name}</a> said
	  <a class="_" title="{time}"></a>:
	</div>
	<div class="text"></div>
      </div>
    </div>
  </div>

  <hr/>  

  <div class="comment-form-loading" style="display:none">
    <img src="../../images/loading.gif"></img>
    Posting Comment...
  </div>

  <div class="comment-form">
    <h4>Leave a comment</h4>
    <form>
      <input type="hidden" name="guid" value="9dba2130-5d6c-012b-b53a-001a92975b89"/>
      <p>
	<label>Name</label><br/>
	<input type="text" name="name" size="40"/>
      </p>
      <p>
	<label>Website</label><br/>
	<input type="text" name="website"  size="40"/>
      </p>
      <p>
	<label>Comment (Use markdown for formatting)</label><br/>
	<textarea name="text" cols="60" rows="10"></textarea>
      </p>
      <p>
	<input type="submit" value="Post comment"/>
      </p>
    </form>
  </div>
</div>



      </div>

      <div class="right column span-5 last"> 
	<h4>Subscribe</h4>
	<p>
	  <a href="http://feeds.feedburner.com/matthias-georgi" rel="alternate" type="application/rss+xml">
	    <img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/>
	  </a>&nbsp;
	  <a href="http://feeds.feedburner.com/matthias-georgi" rel="alternate" type="application/rss+xml">
	    Subscribe in a reader
	  </a>
	  <form action="http://www.feedburner.com/fb/a/emailverify" method="post" target="popupwindow" onsubmit="window.open('http://www.feedburner.com/fb/a/emailverifySubmit?feedId=2408112', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true">
	    <p>Enter your email address:</p>
	    <p><input type="text" style="width:140px" name="email"/></p>
	    <input type="hidden" value="http://feeds.feedburner.com/~e?ffid=2408112" name="url"/>
	    <input type="hidden" value="Matthias Georgi" name="title"/>
	    <input type="hidden" name="loc" value="en_US"/>
	    <input type="submit" value="Subscribe by email" />
	  </form>
	</p>
	<h4>About</h4>
	<div class="about">
	  <strong>Matthias Georgi</strong> lives in
	  <em>Darmstadt, Germany</em> and works as a freelance
	  software developer.
	  <a href="../../about.html">read more</a>
	</div>
	<h4>Archives</h4>
	<ul>
	  
	    <li><a href="../../2007/4/index.html">April 2007</a></li> 
	  
	    <li><a href="../../2007/5/index.html">May 2007</a></li> 
	  
	    <li><a href="../../2008/9/index.html">September 2008</a></li> 
	  
	</ul>
	<h4>Recent posts</h4>
	<ul>
	  
	    <li><a href="../../2008/9/commenting-system-with-lightweight-json-store.html">Commenting system with lightweight JSON store</a></li> 
	  
	    <li><a href="../../2008/9/shinmun-a-small-and-beautiful-blog-engine.html">Shinmun, a small and beautiful blog engine</a></li> 
	  
	    <li><a href="../../2008/9/emacs-completions.html">Emacs Completions</a></li> 
	  
	    <li><a href="../../2007/5/google-like-search-results-helper.html">Google-like Search Results Helper</a></li> 
	  
	    <li><a href="../../2007/4/dry-up-your-url-helpers.html">DRY Up Your Url Helpers</a></li> 
	  
	</ul>
	<h4>My Projects</h4>
	<ul>
	  <li>
	    <a href="http://github.com/georgi/shinmun/tree/master">
	      Shinmun, a small blog engine
	    </a>
	  </li>
	</ul>
	<h4>My Music</h4>
	<ul>
	  <li>
	    <a href="http://www.p-ersag.com">
	      Planet Ersag
	    </a>
	  </li>
	</ul>
      </div>
    </div>

    <script type="text/javascript" src="../../javascripts/all.js?1220823609"></script>
<script type="text/javascript" src="../../javascripts/highlight.js?1216329729"></script>
<script type="text/javascript" src="../../javascripts/showdown.js?1205881696"></script>
<script type="text/javascript" src="../../javascripts/template.js?1220744554"></script>
<script type="text/javascript" src="../../javascripts/default.js?1220656864"></script>
<script type="text/javascript" src="../../javascripts/comments.js?1220809707"></script>
<script type="text/javascript" src="../../javascripts/wmd.js?1205881696"></script>

    <script type="text/javascript">
      hljs.initHighlightingOnLoad('ruby', 'html', 'css', 'php', 'javascript', 'sql', 'lisp', 'xml', 'java');
    </script>

    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>

    <script type="text/javascript">
      var pageTracker = _gat._getTracker("UA-927203-10");
      pageTracker._trackPageview();
    </script>

  </body>
</html>
