<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Matthias Georgi - Rendering markaby in your helpers</title>
    <meta http-equiv="Content-Language" content="English" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/matthias-georgi" />
    <link href="../../stylesheets/all.css?1220869365" media="screen" rel="stylesheet"></link>
<link href="../../stylesheets/style.css?1220823092" media="screen" rel="stylesheet"></link>
    <script>var Blog = { root: '../../', guid: '9dba8080-5d6c-012b-b53a-001a92975b89' };</script>
  </head>
  <body>
    <div class="container">

      <div id="header" class="column span-20 last">
	<h1><a href="../../index.html">Matthias Georgi</a></h1>
	<h2>Webdev, Gamedev, Interaction Design</h2>
      </div>

      <div id="navi"  class="column span-20 last">
	<ul>
	  <li><a class="" href="../../index.html">Home</a></li>
	  
	    <li><a class="active" href="../../categories/ruby.html">Ruby</a></li>
	  
	    <li><a class="" href="../../categories/javascript.html">Javascript</a></li>
	  
	    <li><a class="" href="../../categories/emacs.html">Emacs</a></li>
	  
	  <li><a class="" href="../../about.html">About</a></li>
	</ul>
      </div>

      
	<div id="header-text" class="column span-20 last">
	  <h1>Ruby</h1>
	</div>
      

      <div class="content column span-15"> 
	<div class="article">

  <div class="date">
    April 2, 2007
  </div>

  <h2>Rendering markaby in your helpers</h2>  

  <p>Generating markup in your rails helpers is a general practice in rails
and is used throughout all rails helpers. Normally you use <code>content_tag</code>
to generate markup. But often you will encounter situations, where
nested tags force you to write ugly helper code like the following
helper method from the rails library:</p>

<pre><code>def options_for_select(container, selected = nil)
 container = container.to_a if Hash === container

 options_for_select = container.inject([]) do |options, element|
    if !element.is_a?(String) and element.respond_to?(:first) and element.respond_to?(:last)
     is_selected = ( (selected.respond_to?(:include?) &amp;&amp; !selected.is_a?(String) ? selected.include?(element.last) : element.last == selected) )
      if is_selected
       options &lt;&lt; "&lt;option value=\"#{html_escape(element.last.to_s)}\" selected=\"selected\"&gt;#{html_escape(element.first.to_s)}&lt;/option&gt;"
     else
       options &lt;&lt; "&lt;option value=\"#{html_escape(element.last.to_s)}\"&gt;#{html_escape(element.first.to_s)}&lt;/option&gt;"
     end
   else
     is_selected = ( (selected.respond_to?(:include?) &amp;&amp; !selected.is_a?(String) ? selected.include?(element) : element == selected) )
     options &lt;&lt; ((is_selected) ? "&lt;option value=\"#{html_escape(element.to_s)}\" selected=\"selected\"&gt;#{html_escape(element.to_s)}&lt;/option&gt;" : "&lt;option value=\"#{html_escape(element.to_s)}\"&gt;#{html_escape(element.to_s)}&lt;/option&gt;")
   end
  end

 options_for_select.join("\n")
end
</code></pre>

<p>We will now rewrite this code with inline markaby. We need therefore the following helper method:</p>

<pre><code>def markaby(&amp;proc)
  assigns = {}
  instance_variables.each do |name|
    assigns[ name[1..-1] ] =  instance_variable_get(name)
  end
  Markaby::Builder.new(assigns, self).capture(&amp;proc)
end
</code></pre>

<p>We need to collect the instance variables of the current template and
pass a hash of instance variable names along with their values to the
markaby builder. As second parameter we pass the current template, so
that the builder can access other helper methods. </p>

<p>Ok, let&#8217;s rewrite the <code>options_for_select</code> helper. The method takes an
array of values which should be displayed as options. Alternatively
you may pass an list of pairs like <code>[['first',1],['second',2]</code> or an
<em>Hash</em>, which maps from option labels to their values. One thing I did
was to refactor the <code>is_selected test</code> into a lambda. It is cleaner to
separate the test and probably more efficient. Inside the loop we are
testing, if we have pairs or simple values and generate markup by
sending the option method to the builder, which causes the markaby
builder to generate an option tag. Tag attributes are defined with a
hash, which we pass to the option method. A tag method takes an
optional block, which defines the content of a tag, in our case simply
the text of the option.</p>

<pre><code>def options_for_select(container, selected = nil)
  container = container.to_a if Hash === container

  if selected.respond_to?(:include?) and !selected.is_a?(String)
    is_selected = lambda { |e| selected.include? e }
  else
    is_selected = lambda { |e| selected == e }
  end

  is_pair = lambda {|e| !e.is_a?(String) and e.respond_to?(:first) and e.respond_to?(:last) }

  markaby do
    container.each do |element|
      if is_pair[element]
        if is_selected[element.last]
          option(:value =&gt; element.last, :selected =&gt; 'selected') { h element.first }
        else
           option(:value =&gt; element.last) { h element.first }
        end
      else
        if is_selected[element]
          option(:value =&gt; element, :selected =&gt; 'selected') { h element }
        else
          option(:value =&gt; element) { h element }
        end
      end
    end
  end
end
</code></pre>

<p>Our defined markaby method is even more useful, we can accept a block
for our helper method and use it inside the markaby code:</p>

<pre><code>def tasks(&amp;block)
  markaby do
    div.tasks {
      ul {
        markaby(&amp;amp;block)
      }
    }
  end
end
</code></pre>

<p>If we have a common pattern like a list of tasks for many templates,
we can generate the common code with the tasks method and put the
actual tasks in the block:</p>

<pre><code>tasks {
  task 'Back to articles'.t, articles_url
  task :edit, @article
  task :versions, @article
}
</code></pre>

<p>So, you can see, there is also a task helper, which is defined as follows:</p>

<pre><code>def task(text, url_or_resource, html_options={})
  if text.is_a? Symbol
    task "#{text.to_s.humanize}".t, {:action =&gt; text, :id =&gt; url_or_resource}, html_options
  else
    markaby { li { link_to text, url_or_resource, html_options } }
  end
end
</code></pre>

<p>If the link text is a symbol, we are going to infer the url from the
action name which is the first parameter and the recource, which is
the second parameter in this case. Otherwise we generate a list
element and delegate the arguments to the <code>link_to helper</code>. By using
this simple abstraction, we have hidden the details of task links,
which is really DRY. Instead of repeating the same pattern over and
over again, we have a common place to decide, how the tasks should
look like. Markaby makes it really easy to generate nested structures,
as it takes advantage of ruby&#8217;s block syntax. In a future post I will
discuss an advanced form builder, like the one already implemented in
Rails, but this time implemented with the help of Markaby. It is even
possible to separate form generation and form layouting by using a
separate form renderer. So step by, if you want to delve into further
Markaby Magic.</p>

  <h3>Comments</h3>

  <div class="comments-loading" style="display:none">
    <img src="../../images/loading.gif"></img>
    Loading Comments...
  </div>

  <div class="comments">  
    <div id="comments-template">
      <div class="comment">
	<div class="_ top">
	  <a class="_" href="{website}">{name}</a> said
	  <a class="_" title="{time}"></a>:
	</div>
	<div class="text"></div>
      </div>
    </div>
  </div>

  <hr/>  

  <div class="comment-form-loading" style="display:none">
    <img src="../../images/loading.gif"></img>
    Posting Comment...
  </div>

  <div class="comment-form">
    <h4>Leave a comment</h4>
    <form>
      <input type="hidden" name="guid" value="9dba8080-5d6c-012b-b53a-001a92975b89"/>
      <p>
	<label>Name</label><br/>
	<input type="text" name="name" size="40"/>
      </p>
      <p>
	<label>Website</label><br/>
	<input type="text" name="website"  size="40"/>
      </p>
      <p>
	<label>Comment (Use markdown for formatting)</label><br/>
	<textarea name="text" cols="60" rows="10"></textarea>
      </p>
      <p>
	<input type="submit" value="Post comment"/>
      </p>
    </form>
  </div>
</div>



      </div>

      <div class="right column span-5 last"> 

	<h4>Subscribe</h4>

	<p>
	  <a href="http://feeds.feedburner.com/matthias-georgi" rel="alternate" type="application/rss+xml">
	    <img src="../../images/rss.png"></img>
	    <img src="http://feeds.feedburner.com/~fc/matthias-georgi?bg=99CCFF&amp;fg=444444&amp;anim=0" height="26" width="88"/>
	</p>

	<h4>About</h4>

	<div class="about">
	  <strong>Matthias Georgi</strong> lives in
	  <em>Darmstadt, Germany</em> and works as a freelance
	  software developer.
	  <a href="../../about.html">read more</a>
	</div>

	<h4>Archives</h4>

	<ul>
	  
	    <li><a href="../../2007/4/index.html">April 2007</a></li> 
	  
	    <li><a href="../../2007/5/index.html">May 2007</a></li> 
	  
	    <li><a href="../../2008/9/index.html">September 2008</a></li> 
	  
	</ul>

	<h4>Recent posts</h4>

	<ul>
	  
	    <li><a href="../../2008/9/commenting-system-with-lightweight-json-store.html">Commenting system with lightweight JSON store</a></li> 
	  
	    <li><a href="../../2008/9/shinmun-a-small-and-beautiful-blog-engine.html">Shinmun, a small and beautiful blog engine</a></li> 
	  
	    <li><a href="../../2008/9/emacs-completions.html">Emacs Completions</a></li> 
	  
	    <li><a href="../../2007/5/google-like-search-results-helper.html">Google-like Search Results Helper</a></li> 
	  
	    <li><a href="../../2007/4/dry-up-your-url-helpers.html">DRY Up Your Url Helpers</a></li> 
	  
	</ul>

	<h4>My Projects</h4>

	<ul>
	  <li>
	    <a href="http://github.com/georgi/shinmun/tree/master">
	      Shinmun, a small blog engine
	    </a>
	  </li>
	</ul>

	<h4>My Music</h4>

	<ul>
	  <li>
	    <a href="http://www.p-ersag.com">
	      Planet Ersag
	    </a>
	  </li>
	</ul>

      </div>
    </div>

    <script type="text/javascript" src="../../javascripts/all.js?1220869365"></script>
<script type="text/javascript" src="../../javascripts/highlight.js?1216329729"></script>
<script type="text/javascript" src="../../javascripts/showdown.js?1205881696"></script>
<script type="text/javascript" src="../../javascripts/template.js?1220744554"></script>
<script type="text/javascript" src="../../javascripts/default.js?1220656864"></script>
<script type="text/javascript" src="../../javascripts/comments.js?1220809707"></script>
<script type="text/javascript" src="../../javascripts/wmd.js?1205881696"></script>

    <script type="text/javascript">
      hljs.initHighlightingOnLoad('ruby', 'html', 'css', 'php', 'javascript', 'sql', 'lisp', 'xml', 'java');
    </script>

    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>

    <script type="text/javascript">
      var pageTracker = _gat._getTracker("UA-927203-10");
      pageTracker._trackPageview();
    </script>

  </body>
</html>
